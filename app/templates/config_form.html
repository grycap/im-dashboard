<!-- start tabs creation section -->
<ul class="nav nav-tabs">
{% set tabs=template['tabs'] %}
{% set inputs=template['inputs'] %}
{% if tabs|length > 0 %}
  {% for tab in tabs %}
    {% set tab_id = tab.replace(" ", "_") %}
    {% if loop.first %}
      <li class="nav-item"><a class="nav-link active" data-id="#{{tab_id}}" data-bs-toggle="tab" href=#{{tab_id}}>{{tab}}</a></li>
    {% else %}
      <li class="nav-item"><a class="nav-link" data-id="#{{tab_id}}" data-bs-toggle="tab" href=#{{tab_id}}>{{tab}}</a></li>
    {% endif %}
  {% endfor %}
{% else %}
  <li class="nav-item"><a class="nav-link active" data-id="#InputValues" data-bs-toggle="tab" href=#InputValues>Input Values</a></li>
{% endif %}
<li class="nav-item"><a class="nav-link" id="tabAdvanced" data-id="#Advanced" data-bs-toggle="tab" href=#Advanced>Cloud Provider</a></li> <!-- always create advanced tab -->
</ul>
  <!-- end tab creation section -->

<div class="tab-content">
  <!-- inputs -->
  {% if tabs|length > 0 %}
    {% for tab in tabs %}
      {% set tab_id = tab.replace(" ", "_") %}
      {% if loop.first %}
        <div id="{{tab_id}}" class="tab-pane fade show active">
      {% else %}
        <div id="{{tab_id}}" class="tab-pane fade">
      {% endif %}

      <br>
      {% for key, value in inputs.items() %}
        {% if value.tab == tab %}
          {% include 'input_types.html' %}
        {% endif %}
      {% endfor %}
      </div>
    {% endfor %}

  {% else %} <!-- no tabs -->
    <div id="InputValues" class="tab-pane fade show active">
      {% for key, value in inputs.items() %}
        {% include 'input_types.html' %}
      {% endfor %}
    </div>
  {% endif %}
  <!-- end inputs -->

  <!-- scheduling -->
  <br>
  <div id="Advanced" class="tab-pane fade">
    {% include 'advanced_config.html' %}
  </div>
</div>

<script>
  // Functio to validate fields of each tab before changing to other tab
 $('.nav-tabs a').on('hide.bs.tab', function(e){
  var link = e.delegateTarget;
  var tab_id = link.getAttribute('data-id')
  var inputs = $(tab_id).find(':input');
  var valid = true;
  for (var i = 0; i < inputs.length; i++) {
    if (!inputs[i].checkValidity()) {
      inputs[i].reportValidity();
      valid = false;
    }
  }
  // Check if the current tab is "tabAdvanced"
  if (tab_id === "#Advanced") {
    // if we are leaving the advanced tab, we need to reset the selected credentials
    $('#selectedCred').val('').trigger('change');
  }
  return valid;
});

// Manejar habilitación condicional basada en enabled_by

function setupEnabledByLogic() {
  const inputsWithEnabledBy = document.querySelectorAll('[data-enabled-by]');

  // Loguear todos los inputs para ver su estructura
  const allInputs = document.querySelectorAll('input[id], textarea[id], select[id]');
  allInputs.forEach(function(elem) {
    const hasEnabledBy = elem.hasAttribute('data-enabled-by');
    const enabled = !elem.hasAttribute('disabled');
  });

  inputsWithEnabledBy.forEach(function(input) {
    const enabledByFieldId = input.getAttribute('data-enabled-by');
    const enabledByField = document.getElementById(enabledByFieldId);

    if (enabledByField) {
      // Función para actualizar el estado del input

      function updateInputState() {
        let isEnabled = false;

        // Para checkboxes/toggles, verificar el estado checked
        if (enabledByField.type === 'checkbox' || enabledByField.type === 'radio') {
          isEnabled = enabledByField.checked;
        // Para otros tipos, verificar si el valor es truthy
        } else {
          const val = enabledByField.value;
          isEnabled = val === 'true' || val === 'True' || val === true || val === '1' || (val && val !== '0' && val !== 'false');
        }

        if (isEnabled) {
          input.removeAttribute('disabled');
        } else {
          input.setAttribute('disabled', 'disabled');
        }
      }

      // Inicializar el estado
      updateInputState();

      // Escuchar cambios en el campo habilitador - múltiples eventos
      enabledByField.addEventListener('change', function(e) {
        updateInputState();
      });

      enabledByField.addEventListener('input', function(e) {
        updateInputState();
      });
    }
  });
}

// Ejecutar la configuración al cargar la página
setupEnabledByLogic();


</script>
